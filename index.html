<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>CSV to JSON</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <p id="heading">CSV to JSON Converter</p>
    <p class="small"><a href="http://jsfiddle.net/sturtevant/vUnF9/" target="_blank">JSON to CSV Converter</a>
    <hr />
    <p>Paste Your CSV Here:</p>
    <textarea id="csv" class="text">Capacity, Monthly Price, Start Day, End Day
1, 600, 2014-07-01,
1, 400, 2014-04-02,
1, 400, 2014-05-01,
5, 2800, 2014-03-01, 2014-04-30
2, 1500, 2014-05-01, 2014-06-30
4, 1700, 2014-04-01,
3, 1300, 2014-04-01,
15, 6500, 2014-05-01, 2014-08-31
1, 400, 2014-05-01,
1, 400, 2014-05-01,
3, 1400, 2014-05-01,
18, 7200, 2014-05-01,
1, 800, 2014-06-01,
1, 700, 2014-05-01, 2014-06-30
2, 1250, 2014-04-16, 2014-06-02
1, 600, 2013-11-01, 2014-05-31
8, 4000, 2014-06-02, 2014-07-31
2, 1300, 2014-05-01, 2014-10-31
4, 2200, 2014-05-01,
14, 11875, 2014-06-01,
2, 1500, 2014-05-01, 2014-08-31
2, 1500, 2012-06-01,
3, 1850, 2014-04-09, 2014-08-06
2, 1100, 2014-05-01, 2014-09-30
1, 625, 2014-04-11,
1, 1000, 2014-02-14,
1, 400, 2014-05-01,
6, 3600, 2014-04-02,
2, 950, 2013-02-01, 2014-05-31
4, 2500, 2013-06-01, 2014-04-30
2, 1200, 2014-07-01, 2014-08-31
1, 950, 2014-06-01, 2014-08-31
4, 3200, 2014-04-01, 2014-09-30
1, 400, 2014-03-27, 2014-04-10
4, 2600, 2014-02-01, 2014-04-08
11, 5500, 2014-05-01,
2, 1200, 2014-05-01, 2014-07-02
1, 600, 2014-05-01, 2014-07-31
1, 800, 2013-11-01, 2014-04-30
1, 700, 2013-05-01,
2, 900, 2014-07-01, 2014-08-31
2, 1400, 2014-04-02,
2, 1500, 2014-05-01,
2, 1200, 2014-05-01,
2, 1500, 2014-05-01, 2014-10-31
2, 900, 2014-02-01,
1, 400, 2014-04-14,
2, 900, 2014-01-01, 2014-06-30
2, 1000, 2013-12-01, 2014-06-30
9, 4500, 2014-02-06, 2014-04-30
4, 2500, 2013-08-01,
6, 2900, 2013-05-01, 2014-05-31
1, 600, 2014-04-09,
2, 1700, 2014-02-14, 2014-04-30
2, 900, 2014-07-01,
1, 400, 2014-05-01, 2014-10-31
2, 0, 2014-04-15, 2014-05-01
4, 2500, 2014-05-01,
4, 3600, 2014-05-01,
9, 4950, 2014-05-01,
2, 1100, 2014-05-12,
6, 2700, 2014-05-01, 2014-08-31
16, 350, 2014-04-01, 2014-08-31
2, 1300, 2012-10-01,
1, 950, 2014-06-01, 2014-06-08
3, 2000, 2014-06-01, 2014-06-30
8, 3600, 2014-07-08,
6, 5400, 2014-05-12,
4, 2700, 2013-09-01,
4, 2600, 2012-06-01, 2014-05-31
4, 2700, 2012-07-01, 2014-04-30
1, 450, 2014-04-02,
4, 2700, 2014-04-01, 2014-04-30
4, 2200, 2014-06-01, 2014-10-31
</textarea>
    <br />
    <button id="convert">Convert to JSON</button>
    &nbsp;&nbsp;
    <button id="download">Download JSON</button>
    <textarea id="json" class="text"></textarea>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script>

    function CSVToArray(strData, strDelimiter) {
      strDelimiter = (strDelimiter || ",");
      var objPattern = new RegExp((
      "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
      "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
      "([^\"\\" + strDelimiter + "\\r\\n]*))"), "gi");
      var arrData = [[]];

      var arrMatches = null;

      while (arrMatches = objPattern.exec(strData)) {
        var strMatchedDelimiter = arrMatches[1];

        if (strMatchedDelimiter.length && (strMatchedDelimiter != strDelimiter)) {

          arrData.push([]);
        }

        if (arrMatches[2]) {

          var strMatchedValue = arrMatches[2].replace(
            new RegExp("\"\"", "g"), "\"");
        } else {
          var strMatchedValue = arrMatches[3];
        }

        arrData[arrData.length - 1].push(strMatchedValue);
      }
      return (arrData);
    }

    function CSV2JSON(csv) {
      var array = CSVToArray(csv);
      var objArray = [];
      for (var i = 1; i < array.length; i++) {
        objArray[i - 1] = {};
        for (var k = 0; k < array[0].length && k < array[i].length; k++) {
          var key = array[0][k];

          objArray[i - 1][key] = array[i][k]
        }
        objArray[i - 1].id = i-1;
      }
      const date = new Date("2017-01")
      const sortedArrayByDate = _.sortBy(objArray, reservation=>reservation[" Start Day"]);
      console.log('sortedArrayByDate',sortedArrayByDate);
      const revenueAndCapacityDBs = generateRevenueAndCapacityDBs(sortedArrayByDate);
      consoleRevenueByDate(revenueAndCapacityDBs, date)
      var json = JSON.stringify(sortedArrayByDate);
      var str = json.replace(/},/g, "},\r\n");
      return str;
    }

    function generateRevenueAndCapacityDBs(sortedArrayByDate){
      const shortTermsReservations = _.map(sortedArrayByDate, (reservation) => {
        let startDate = moment(reservation[" Start Day"])
        let endDate = reservation[" End Day"].length > 0 ? moment(reservation[" End Day"]) : null
        return serializeShortTermReservation(reservation.id, reservation["Capacity"], reservation[" Monthly Price"], startDate, endDate)
      })
      let olderReservationsSum = 0;
      let shortTermResDB = {};
      let longTermResDB = {};
      for(let i =0 ; i< shortTermsReservations.length; i++) {
        currResObj = shortTermsReservations[i];
        if(currResObj && currResObj.type === "shortTerm"){
          for (var year in currResObj) {
            if(_.has(shortTermResDB, year)) {
              for (var month in currResObj[year]) {
                if(_.has(shortTermResDB[year], month)) {
                  shortTermResDB[year][month] = {
                    revenue: shortTermResDB[year][month].revenue + currResObj[year][month],
                    capacity: shortTermResDB[year][month].capacity + currResObj.capacity
                  };
                } else {
                  shortTermResDB[year][month] = {
                    revenue: 0,
                    capacity: 0
                  };
                  shortTermResDB[year][month] = {
                    revenue: shortTermResDB[year][month].revenue + currResObj[year][month],
                    capacity: shortTermResDB[year][month].capacity + currResObj.capacity
                  };
                }
              }
            } else {
              if(year === "id" || year === "capacity" || year === "type"){
                continue;
              }
              shortTermResDB[year] = {}
              for (var month in currResObj[year]) {
                shortTermResDB[year][month] = {
                  revenue: 0,
                  capacity: 0
                };
                shortTermResDB[year][month] = {
                  revenue: shortTermResDB[year][month].revenue + currResObj[year][month],
                  capacity: shortTermResDB[year][month].capacity + currResObj.capacity
                };
              }
            }
          }
        } else {
          const year = currResObj.startDate.format('YYYY');
          const month = currResObj.startDate.format('MM');
          const prevMonth = month === 1 ? 12 : month-1;
          const prevYear = month === 1 ? year-1 : year
          if(_.has(longTermResDB, year)) {
              if(_.has(longTermResDB[year], month)) {
                longTermResDB[year][month] = {
                  currentMonthRevenue: longTermResDB[year][month].currentMonthRevenue + currResObj.firstMonthRev,
                  capacity: longTermResDB[year][month].capacity + currResObj.capacity
                };
                if(month === 12){
                  year = year+1;
                  month = 1
                }
                longTermResDB[year][month].oldersReservationsRevenue = olderReservationsSum + currResObj.monthlyPrice
              } else {
                longTermResDB[year][month] = {
                  currentMonthRevenue: currResObj.firstMonthRev + olderReservationsSum,
                  capacity: currResObj.capacity,
                  oldersReservationsRevenue: 0
                };
                if(month === 12){
                  year = year+1;
                  month = 1
                }
                longTermResDB[year][month].oldersReservationsRevenue = olderReservationsSum + currResObj.monthlyPrice
            }
          } else {
              longTermResDB[year] = {}
              longTermResDB[year][month] = {
                currentMonthRevenue: currResObj.firstMonthRev + olderReservationsSum,
                capacity: currResObj.capacity,
                oldersReservationsRevenue: 0,
              };
              if(month === 12){
                year = year+1;
                month = 1
              }
              longTermResDB[year][month].oldersReservationsRevenue = olderReservationsSum + currResObj.monthlyPrice
            }
            olderReservationsSum = olderReservationsSum + currResObj.monthlyPrice
        }
    }
    return {shortTermResDB, longTermResDB};
    }

    function getMonthRevenue(monthlyPrice, daysInMonth, reseredDays) {
      const numberedString = monthlyPrice
      return monthlyPrice/daysInMonth*reseredDays;
    }

    function serializeShortTermReservation(reservationId, capacity = 0, monthlyPrice, dateStart = moment('1970-1-1'), dateEnd) {
      monthlyPrice = Number(monthlyPrice)
      let timeValues = [];
      let currDate = _.cloneDeep(dateStart);
      let monthsRev = {}
      if(dateEnd){
        while (currDate.isSameOrBefore(dateEnd)) {
          let monthRevenue;
          if(currDate.diff(dateStart, 'months') === 0 ){
            monthRevenue = getMonthRevenue(monthlyPrice, currDate.daysInMonth(),currDate.daysInMonth()-dateStart.format('DD')+1)
          } else if (currDate.diff(dateEnd, 'months') === 0) {
            monthRevenue = getMonthRevenue(monthlyPrice, currDate.daysInMonth(),dateEnd.format('DD'))
          } else {
            //console.log('Number(monthlyPrice)',Number(monthlyPrice));
            monthRevenue = monthlyPrice
          }
          if(_.has(monthsRev, currDate.format('YYYY'))) {
            monthsRev[currDate.format('YYYY')][currDate.format('MM')] = monthRevenue
          } else {
            monthsRev[currDate.format('YYYY')] = {}
            monthsRev[currDate.format('YYYY')][currDate.format('MM')] = monthRevenue
          }
          currDate.add(1,'month');
        }
        monthsRev.type = "shortTerm";
      } else {
        let monthRevenue;
        if(currDate.diff(dateStart, 'months') === 0 ){
          monthRevenue = getMonthRevenue(monthlyPrice, currDate.daysInMonth(),currDate.daysInMonth()-dateStart.format('DD')+1)
        } else {
          monthRevenue = monthlyPrice
        }
        monthsRev = {
          startDate: dateStart,
          firstMonthRev: monthRevenue,
          monthlyPrice: monthlyPrice,
          capacity: capacity
        }
        monthsRev.type = "longTerm";
      }
      monthsRev.id = reservationId;
      monthsRev.capacity = Number(capacity);
      return monthsRev;
    }

    function getLongTermRevenueByDate(longTermReservationDB, month, year) {
      // CHECK FOR LONG TERM RESERVATIONS REVENUE BY MONTH
      let clonedYear = _.cloneDeep(year)
      if(_.has(longTermReservationDB, year)){ // check if DB has this particular year key
        if(_.has(longTermReservationDB[year], month)){ // check if DB has this particular month key
          return longTermReservationDB[clonedYear][month]
        } else {
          let clonedMonth = month;
            while (clonedMonth > 0) { // search for the closest month <
              clonedMonth = clonedMonth < 10 ? "0"+clonedMonth : clonedMonth;
              if(_.has(longTermReservationDB[clonedYear],[clonedMonth])){
                return longTermReservationDB[clonedYear][clonedMonth].oldersReservationsRevenue
              }
              clonedMonth--
            }
            if(clonedMonth === 0) { // search for the closest month in previouse years
              while(clonedYear > 2012){
                  if(_.has(longTermReservationDB, clonedYear)){
                    clonedMonth = _.findLastKey(longTermReservationDB[clonedYear])
                    return longTermReservationDB[clonedYear][clonedMonth].oldersReservationsRevenue
                  }
                  clonedYear--;
              }
            }
        }
      } else {
          while(clonedYear > 2012){ // search for the closest month in previouse years
              if(_.has(longTermReservationDB, clonedYear)){
                const clonedMonth = _.findLastKey(longTermReservationDB[clonedYear])
                return longTermReservationDB[clonedYear][clonedMonth].oldersReservationsRevenue
              }
              clonedYear--;
          }
      }
    }

    function getShortTermRevenueByDate(shortTermReservationDB, year, month) {
      if(_.has(shortTermReservationDB, year) && _.has(shortTermReservationDB[year], month)){
        return shortTermReservationDB[year][month].revenue;
      } else {
         return 0;
      }
    }

    function consoleRevenueByDate(revenueAndCapacityDBs, date) {
      let sum = 0;
      let dateToMoment = moment(date)
      const month = dateToMoment.format('MM');
      const year = Number(dateToMoment.format('YYYY'));
      const shortTermReservationDB = revenueAndCapacityDBs.shortTermResDB;
      const longTermReservationDB = revenueAndCapacityDBs.longTermResDB;
      let revenueSum = 0;
      revenueSum = getLongTermRevenueByDate(longTermReservationDB, month, year);
      revenueSum += getShortTermRevenueByDate(shortTermReservationDB, year, month);
      // CHECK FOR SHORT TERM RESERVATIONS REVENUE BY MONTH

      console.log('revenueSum',revenueSum);
    }

    $(document).ready(function() {
      $.ajax({
        type: "GET",
        url: "https://gist.githubusercontent.com/yonbergman/7a0b05d6420dada16b92885780567e60/raw/114aa2ffb1c680174f9757431e672b5df53237eb/data.csv",
        dataType: "text",
        success: function(data) {CSV2JSON(data);}
      });

      $("#convert").click(function() {
        var csv = $("#csv").val();
        var json = CSV2JSON(csv);
        $("#json").val(json);
      });

      $("#download").click(function() {
        var csv = $("#csv").val();
        var json = CSV2JSON(csv);
        window.open("data:text/json;charset=utf-8," + escape(json))
      });
    });
  </script>
</html>
