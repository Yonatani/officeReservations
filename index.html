<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>CSV to JSON</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <p id="heading">CSV to JSON Converter</p>
    <p class="small"><a href="http://jsfiddle.net/sturtevant/vUnF9/" target="_blank">JSON to CSV Converter</a>
    <hr />
    <p>Paste Your CSV Here:</p>
    <textarea id="csv" class="text">Capacity, Monthly Price, Start Day, End Day
1, 600, 2014-07-01,
1, 400, 2014-04-02,
1, 400, 2014-05-01,
5, 2800, 2014-03-01, 2014-04-30
2, 1500, 2014-05-01, 2014-06-30
4, 1700, 2014-04-01,
3, 1300, 2014-04-01,
15, 6500, 2014-05-01, 2014-08-31
1, 400, 2014-05-01,
1, 400, 2014-05-01,
3, 1400, 2014-05-01,
18, 7200, 2014-05-01,
1, 800, 2014-06-01,
1, 700, 2014-05-01, 2014-06-30
2, 1250, 2014-04-16, 2014-06-02
1, 600, 2013-11-01, 2014-05-31
8, 4000, 2014-06-02, 2014-07-31
2, 1300, 2014-05-01, 2014-10-31
4, 2200, 2014-05-01,
14, 11875, 2014-06-01,
2, 1500, 2014-05-01, 2014-08-31
2, 1500, 2012-06-01,
3, 1850, 2014-04-09, 2014-08-06
2, 1100, 2014-05-01, 2014-09-30
1, 625, 2014-04-11,
1, 1000, 2014-02-14,
1, 400, 2014-05-01,
6, 3600, 2014-04-02,
2, 950, 2013-02-01, 2014-05-31
4, 2500, 2013-06-01, 2014-04-30
2, 1200, 2014-07-01, 2014-08-31
1, 950, 2014-06-01, 2014-08-31
4, 3200, 2014-04-01, 2014-09-30
1, 400, 2014-03-27, 2014-04-10
4, 2600, 2014-02-01, 2014-04-08
11, 5500, 2014-05-01,
2, 1200, 2014-05-01, 2014-07-02
1, 600, 2014-05-01, 2014-07-31
1, 800, 2013-11-01, 2014-04-30
1, 700, 2013-05-01,
2, 900, 2014-07-01, 2014-08-31
2, 1400, 2014-04-02,
2, 1500, 2014-05-01,
2, 1200, 2014-05-01,
2, 1500, 2014-05-01, 2014-10-31
2, 900, 2014-02-01,
1, 400, 2014-04-14,
2, 900, 2014-01-01, 2014-06-30
2, 1000, 2013-12-01, 2014-06-30
9, 4500, 2014-02-06, 2014-04-30
4, 2500, 2013-08-01,
6, 2900, 2013-05-01, 2014-05-31
1, 600, 2014-04-09,
2, 1700, 2014-02-14, 2014-04-30
2, 900, 2014-07-01,
1, 400, 2014-05-01, 2014-10-31
2, 0, 2014-04-15, 2014-05-01
4, 2500, 2014-05-01,
4, 3600, 2014-05-01,
9, 4950, 2014-05-01,
2, 1100, 2014-05-12,
6, 2700, 2014-05-01, 2014-08-31
16, 350, 2014-04-01, 2014-08-31
2, 1300, 2012-10-01,
1, 950, 2014-06-01, 2014-06-08
3, 2000, 2014-06-01, 2014-06-30
8, 3600, 2014-07-08,
6, 5400, 2014-05-12,
4, 2700, 2013-09-01,
4, 2600, 2012-06-01, 2014-05-31
4, 2700, 2012-07-01, 2014-04-30
1, 450, 2014-04-02,
4, 2700, 2014-04-01, 2014-04-30
4, 2200, 2014-06-01, 2014-10-31
</textarea>
    <br />
    <button id="convert">Convert to JSON</button>
    &nbsp;&nbsp;
    <button id="download">Download JSON</button>
    <textarea id="json" class="text"></textarea>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script>

    function CSVToArray(strData, strDelimiter) {
      strDelimiter = (strDelimiter || ",");
      var objPattern = new RegExp((
      "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
      "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
      "([^\"\\" + strDelimiter + "\\r\\n]*))"), "gi");
      var arrData = [[]];

      var arrMatches = null;

      while (arrMatches = objPattern.exec(strData)) {
        var strMatchedDelimiter = arrMatches[1];

        if (strMatchedDelimiter.length && (strMatchedDelimiter != strDelimiter)) {

          arrData.push([]);
        }

        if (arrMatches[2]) {

          var strMatchedValue = arrMatches[2].replace(
            new RegExp("\"\"", "g"), "\"");
        } else {
          var strMatchedValue = arrMatches[3];
        }

        arrData[arrData.length - 1].push(strMatchedValue);
      }
      return (arrData);
    }

    function CSV2JSON(csv) {
      var array = CSVToArray(csv);
      var objArray = [];
      for (var i = 1; i < array.length; i++) {
        objArray[i - 1] = {};
        for (var k = 0; k < array[0].length && k < array[i].length; k++) {
          var key = array[0][k];
          objArray[i - 1][key] = array[i][k]
        }
      }
      const tempDate = new Date("2013-01")
      const sortedArrayByDate = _.sortBy(objArray, reservation=>reservation[" Start Day"]);
      const shortTermsReservations = _.map(sortedArrayByDate, (reservation) => {
        console.log('reservation',reservation)
        let startDate = moment(reservation[" Start Day"])
        let endDate = moment(reservation[" End Day"])
        if(endDate.isValid()){
          return {
            Capacity: reservation.Capacity,
            startDate,
            endDate,
            revenueByMonth: serializeShortTermReservations(startDate, endDate, reservation[" Monthly Price"])
          }
        } else {

        }
      })
      consoleRevenueByTempDate(sortedArrayByDate, tempDate)
      var a = moment('1-3-2012', 'DD-MM-YYYY');
      var b = moment('3-3-2012', 'DD-MM-YYYY');
      var days = b.diff(a, 'days') + 1;
      console.log('shortTermsReservations',shortTermsReservations);




      var json = JSON.stringify(sortedArrayByDate);
      var str = json.replace(/},/g, "},\r\n");

      return str;
    }

    function getMonthRevenue(monthlyPrice, daysInMonth, reseredDays) {
      console.log('reseredDays',reseredDays);
      return monthlyPrice/daysInMonth*(reseredDays);
    }

    function serializeShortTermReservations(dateStart = moment('2013-8-31'), dateEnd = moment('2015-3-30'), monthlyPrice = 1) {
      let timeValues = [];
      let currDate = dateStart;
      while (dateEnd > currDate) {
        let monthRevenue;
        if(currDate.isSame(dateStart)){
          monthRevenue = getMonthRevenue(monthlyPrice, currDate.daysInMonth(),currDate.daysInMonth()-dateStart.format('DD')+1)
        } else if (currDate.isSame(dateEnd)) {
          monthRevenue = getMonthRevenue(monthlyPrice, currDate.daysInMonth(),currDate.daysInMonth()-dateEnd.format('DD')+1)
        } else {
          monthRevenue = monthlyPrice
        }




         timeValues.push({
           "year": currDate.format('YYYY'),
           "month": currDate.format('MM'),
           "daysInMonth":currDate.daysInMonth(),
           "monthRevenue": monthRevenue
      })
      currDate.add(1,'month');
    }
      const chainedYears = _.chain(timeValues).groupBy('year').mapValues( (v) => {
        console.log('monthhh',v);
          return _.chain(v).map((v) => {

            return {[v.month]: 100}}
          ).value();
      }).value();
      console.log('timeValues',chainedYears);
      return chainedYears;
    }

    function consoleRevenueByTempDate(sortedArrayByDate, tempDate) {
      let sum = 0;
      let tempSum = 0;
      let toMoment = moment(tempDate)
      for(let i=0; i<sortedArrayByDate.length; i++){
        if(sortedArrayByDate[i][" Monthly Price"]) { //because i have an undefined on the last row FIX
          let currStartDate = moment(sortedArrayByDate[i][" Start Day"])
          let currEndDate = moment(sortedArrayByDate[i][" End Day"])
          if(toMoment.isAfter(currStartDate) && toMoment.isSameOrBefore(currEndDate)){
            //get the sum from the short-term reservations data
            sum+=Number(sortedArrayByDate[i][" Monthly Price"]);
          } else if (toMoment.isAfter(currStartDate) && currEndDate.isValid()) {
            //get the sum of permanent reservations
          }
          tempSum+=Number(sortedArrayByDate[i][" Monthly Price"]);

        }
      }
      console.log('sum',sum)
      console.log('tempSum',tempSum)
    }

    $(document).ready(function() {
      $.ajax({
        type: "GET",
        url: "https://gist.githubusercontent.com/yonbergman/7a0b05d6420dada16b92885780567e60/raw/114aa2ffb1c680174f9757431e672b5df53237eb/data.csv",
        dataType: "text",
        success: function(data) {CSV2JSON(data);}
      });

      $("#convert").click(function() {
        var csv = $("#csv").val();
        var json = CSV2JSON(csv);
        $("#json").val(json);
      });

      $("#download").click(function() {
        var csv = $("#csv").val();
        var json = CSV2JSON(csv);
        window.open("data:text/json;charset=utf-8," + escape(json))
      });
    });
  </script>
</html>
