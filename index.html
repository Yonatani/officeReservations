<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>CSV to JSON</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <p id="heading">CSV to JSON Converter</p>
    <p class="small"><a href="http://jsfiddle.net/sturtevant/vUnF9/" target="_blank">JSON to CSV Converter</a>
    <hr />
    <p>Paste Your CSV Here:</p>
    <input id="date" type="date" class="text" value="03/12/2017">
    </input>
    <br />
    <button id="convert">Convert to JSON</button>
    &nbsp;&nbsp;
    <button id="download">Download JSON</button>
    <h4 id="revenueTitle" class="text">Total Revenue:</h4>
    <h4 id="revenueSum" class="text">0</h4>
    <h4 id="unreservedCapacityTitle" class="text">Unreserved Capacity:</h4>
    <h4 id="unreservedCapacitySum" class="text">0</h4>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script>

    function CSVToArray(strData, strDelimiter) {
      strDelimiter = (strDelimiter || ",");
      var objPattern = new RegExp((
      "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
      "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
      "([^\"\\" + strDelimiter + "\\r\\n]*))"), "gi");
      var arrData = [[]];

      var arrMatches = null;

      while (arrMatches = objPattern.exec(strData)) {
        var strMatchedDelimiter = arrMatches[1];

        if (strMatchedDelimiter.length && (strMatchedDelimiter != strDelimiter)) {

          arrData.push([]);
        }

        if (arrMatches[2]) {

          var strMatchedValue = arrMatches[2].replace(
            new RegExp("\"\"", "g"), "\"");
        } else {
          var strMatchedValue = arrMatches[3];
        }

        arrData[arrData.length - 1].push(strMatchedValue);
      }
      return (arrData);
    }

    function CSV2JSON(csv) {
      var array = CSVToArray(csv);
      var objArray = [];
      for (var i = 1; i < array.length; i++) {
        objArray[i - 1] = {};
        for (var k = 0; k < array[0].length && k < array[i].length; k++) {
          var key = array[0][k];

          objArray[i - 1][key] = array[i][k]
        }
        objArray[i - 1].id = i-1;
      }
      const sortedArrayByDate = _.sortBy(objArray, reservation=>reservation[" Start Day"]);
      return sortedArrayByDate;
    }


    function generateRevenueAndCapacityDBs(sortedArrayByDate){
      const shortTermsReservations = _.map(sortedArrayByDate, (reservation) => {
        let startDate = moment(reservation[" Start Day"])
        let endDate = reservation[" End Day"].length > 0 ? moment(reservation[" End Day"]) : null
        return serializeShortTermReservation(reservation.id, reservation["Capacity"], reservation[" Monthly Price"], startDate, endDate)
      })
      let olderReservationsRevenueSum = 0;
      let olderReservationsCapacitySum = 0;
      let shortTermResDB = {};
      let longTermResDB = {};
      for(let i =0 ; i< shortTermsReservations.length; i++) {
        currResObj = shortTermsReservations[i];
        if(currResObj && currResObj.type === "shortTerm"){
          for (var year in currResObj) {
            if(_.has(shortTermResDB, year)) {
              for (var month in currResObj[year]) {
                if(_.has(shortTermResDB[year], month)) {
                  shortTermResDB[year][month] = {
                    revenue: shortTermResDB[year][month].revenue + currResObj[year][month],
                    capacity: shortTermResDB[year][month].capacity + currResObj.capacity
                  };
                } else {
                  shortTermResDB[year][month] = {
                    revenue: 0,
                    capacity: 0
                  };
                  shortTermResDB[year][month] = {
                    revenue: shortTermResDB[year][month].revenue + currResObj[year][month],
                    capacity: shortTermResDB[year][month].capacity + currResObj.capacity
                  };
                }
              }
            } else {
              if(year === "id" || year === "capacity" || year === "type"){
                continue;
              }
              shortTermResDB[year] = {}
              for (var month in currResObj[year]) {
                shortTermResDB[year][month] = {
                  revenue: 0,
                  capacity: 0
                };
                shortTermResDB[year][month] = {
                  revenue: shortTermResDB[year][month].revenue + currResObj[year][month],
                  capacity: shortTermResDB[year][month].capacity + currResObj.capacity
                };
              }
            }
          }
        } else {
          const year = currResObj.startDate.format('YYYY');
          const month = currResObj.startDate.format('MM');
          const prevMonth = month === 1 ? 12 : month-1;
          const prevYear = month === 1 ? year-1 : year
          if(_.has(longTermResDB, year)) {
              if(_.has(longTermResDB[year], month)) {
                longTermResDB[year][month] = {
                  currentMonthRevenue: longTermResDB[year][month].currentMonthRevenue + currResObj.firstMonthRev,
                  capacity: olderReservationsCapacitySum + currResObj.capacity
                };
                if(month === 12){
                  year = year+1;
                  month = 1
                }
                longTermResDB[year][month].oldersReservationsRevenue = olderReservationsRevenueSum + currResObj.monthlyPrice;
              } else {
                longTermResDB[year][month] = {
                  currentMonthRevenue: currResObj.firstMonthRev + olderReservationsRevenueSum,
                  capacity: olderReservationsCapacitySum + currResObj.capacity,
                  oldersReservationsRevenue: 0
                };
                if(month === 12){
                  year = year+1;
                  month = 1
                }
                longTermResDB[year][month].oldersReservationsRevenue = olderReservationsRevenueSum + currResObj.monthlyPrice
            }
          } else {
              longTermResDB[year] = {}
              longTermResDB[year][month] = {
                currentMonthRevenue: currResObj.firstMonthRev + olderReservationsRevenueSum,
                capacity: olderReservationsCapacitySum + currResObj.capacity,
                oldersReservationsRevenue: 0,
              };
              if(month === 12){
                year = year+1;
                month = 1
              }
              longTermResDB[year][month].oldersReservationsRevenue = olderReservationsRevenueSum + currResObj.monthlyPrice
            }
            olderReservationsCapacitySum = olderReservationsCapacitySum + currResObj.capacity
            olderReservationsRevenueSum = olderReservationsRevenueSum + currResObj.monthlyPrice
        }
    }
    return {shortTermResDB, longTermResDB};
    }

    function getMonthRevenue(monthlyPrice, daysInMonth, reseredDays) {
      const numberedString = monthlyPrice
      return monthlyPrice/daysInMonth*reseredDays;
    }

    function serializeShortTermReservation(reservationId, capacity = 0, monthlyPrice, dateStart = moment('1970-1-1'), dateEnd) {
      monthlyPrice = Number(monthlyPrice)
      let timeValues = [];
      let currDate = _.cloneDeep(dateStart);
      let monthsRev = {}
      if(dateEnd){
        while (currDate.isSameOrBefore(dateEnd)) {
          let monthRevenue;
          if(currDate.diff(dateStart, 'months') === 0 ){
            monthRevenue = getMonthRevenue(monthlyPrice, currDate.daysInMonth(),currDate.daysInMonth()-dateStart.format('DD')+1)
          } else if (currDate.diff(dateEnd, 'months') === 0) {
            monthRevenue = getMonthRevenue(monthlyPrice, currDate.daysInMonth(),dateEnd.format('DD'))
          } else {
            monthRevenue = monthlyPrice
          }
          if(_.has(monthsRev, currDate.format('YYYY'))) {
            monthsRev[currDate.format('YYYY')][currDate.format('MM')] = monthRevenue
          } else {
            monthsRev[currDate.format('YYYY')] = {}
            monthsRev[currDate.format('YYYY')][currDate.format('MM')] = monthRevenue
          }
          currDate.add(1,'month');
        }
        monthsRev.type = "shortTerm";
      } else {
        let monthRevenue;
        if(currDate.diff(dateStart, 'months') === 0 ){
          monthRevenue = getMonthRevenue(monthlyPrice, currDate.daysInMonth(),currDate.daysInMonth()-dateStart.format('DD')+1)
        } else {
          monthRevenue = monthlyPrice
        }
        monthsRev = {
          startDate: dateStart,
          firstMonthRev: monthRevenue,
          monthlyPrice: monthlyPrice,
          capacity: capacity
        }
        monthsRev.type = "longTerm";
      }
      monthsRev.id = reservationId;
      monthsRev.capacity = Number(capacity);
      return monthsRev;
    }

    function getLongTermRevenueByDate(longTermReservationDB, month, year) {
      // CHECK FOR LONG TERM RESERVATIONS REVENUE BY MONTH
      let clonedYear = _.cloneDeep(year)
      if(_.has(longTermReservationDB, year)){ // check if DB has this particular year key
        if(_.has(longTermReservationDB[year], month)){ // check if DB has this particular month key
          return longTermReservationDB[clonedYear][month]
        } else {
          let clonedMonth = month;
            while (clonedMonth > 0) { // search for the closest month <
              clonedMonth = clonedMonth < 10 ? "0"+clonedMonth : clonedMonth;
              if(_.has(longTermReservationDB[clonedYear],[clonedMonth])){
                return {
                  revenue: longTermReservationDB[clonedYear][clonedMonth].oldersReservationsRevenue,
                  capacity: longTermReservationDB[clonedYear][clonedMonth].capacity
                };
              }
              clonedMonth--
            }
            if(clonedMonth === 0) { // search for the closest month in previouse years
              while(clonedYear > 2012){
                  if(_.has(longTermReservationDB, clonedYear)){
                    clonedMonth = _.findLastKey(longTermReservationDB[clonedYear])
                    return {
                      revenue: longTermReservationDB[clonedYear][clonedMonth].oldersReservationsRevenue,
                      capacity: longTermReservationDB[clonedYear][clonedMonth].capacity
                    };
                  }
                  clonedYear--;
              }
            }
        }
      } else {
          while(clonedYear > 2012){ // search for the closest month in previouse years
              if(_.has(longTermReservationDB, clonedYear)){
                let months = 12
                while (months > 0) { // search for the closest month <
                  let currMonth = months < 10 ? "0"+months : months;
                  if(_.has(longTermReservationDB[clonedYear],[currMonth])){
                    return {
                      revenue: longTermReservationDB[clonedYear][currMonth].oldersReservationsRevenue,
                      capacity: longTermReservationDB[clonedYear][currMonth].capacity
                    };
                  }
                  months--
                }

              }
              clonedYear--;
          }
          return {
            revenue: 0,
            capacity: 0
          };
      }
    }

    function getShortTermRevenueByDate(shortTermReservationDB, month, year) {
      if(_.has(shortTermReservationDB, year) && _.has(shortTermReservationDB[year], month)){
        return {
          revenue: shortTermReservationDB[year][month].revenue,
          capacity: shortTermReservationDB[year][month].capacity
       }
      } else {
         return {
           revenue: 0,
           capacity: 0
        }
      }
    }

    function consoleRevenueByDate(revenueAndCapacityDBs, date) {

      let sum = 0;
      let dateToMoment = moment(date)
      const month = dateToMoment.format('MM');
      const year = Number(dateToMoment.format('YYYY'));
      const shortTermReservationDB = revenueAndCapacityDBs.shortTermResDB;
      const longTermReservationDB = revenueAndCapacityDBs.longTermResDB;

      const longTemoReservationsData = getLongTermRevenueByDate(longTermReservationDB, month, year);
      const shortTemoReservationsData = getShortTermRevenueByDate(shortTermReservationDB, month, year);
      // CHECK FOR SHORT TERM RESERVATIONS REVENUE BY MONTH
      const revenueSum = longTemoReservationsData.revenue + shortTemoReservationsData.revenue;
      const unreservedCapacitySum = 266 - (longTemoReservationsData.capacity + shortTemoReservationsData.capacity);
      return {revenueSum, unreservedCapacitySum}
    }

    $(document).ready(function() {
      let revenueAndCapacityDBs;
      $.ajax({
        type: "GET",
        url: "https://gist.githubusercontent.com/yonbergman/7a0b05d6420dada16b92885780567e60/raw/114aa2ffb1c680174f9757431e672b5df53237eb/data.csv",
        dataType: "text",
        success: function(data) {
          let json = CSV2JSON(data);
          revenueAndCapacityDBs = generateRevenueAndCapacityDBs(json);
        }
      });

      $("#convert").click(function() {
        var date = $("#date").val();
        const totalSum = consoleRevenueByDate(revenueAndCapacityDBs, date)
        $("#revenueSum").text(totalSum.revenueSum);
        $("#unreservedCapacitySum").text(totalSum.unreservedCapacitySum);
        console.log('revenueSum', totalSum.revenueSum);
      });

      $("#download").click(function() {
        var csv = $("#csv").val();
        var json = CSV2JSON(csv);
        window.open("data:text/json;charset=utf-8," + escape(json))
      });
    });
  </script>
</html>
